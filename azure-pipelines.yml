# Branches that trigger a build on commit
trigger:
- main
- rel/*

# Branch(es) that trigger(s) build(s) on PR
pr:
- main
- rel/*

parameters:
- name: isRTM
  displayName: "Release a RTM version?"
  type: boolean
  default: False

variables:
  # Cannot use key:value syntax in root defined variables
  - name: TeamName
    value: MSTest
  - name: NuGet.Version
    value: 5.8.1
  - name: _RunAsInternal
    value: ${{ and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}
  - name: _RunAsPublic
    value: ${{ eq(variables._RunAsInternal, False) }}

  # Produce test-signed binaries for PR and Public builds
  - ${{ if eq(variables._RunAsPublic, True) }}:
    - name: _SignType
      value: test
    - name: _SignArgs
      value: ''
    - name: _Sign
      value: False

  # Produce real signed binaries for Internal builds
  - ${{ if eq(variables._RunAsInternal, True) }}:
    - name: _SignType
      value: real
    - name: _SignArgs
      value: /p:DotNetSignType=$(_SignType) /p:TeamName=$(_TeamName) /p:Sign=$(_Sign)
    - name: _Sign
      value: True

stages:

- stage: Build
  jobs:

  - job: Windows
    timeoutInMinutes: 120
    pool:
      ${{ if eq(variables._RunAsPublic, True) }}:
        vmImage: windows-latest
      ${{ if eq(variables._RunAsInternal, True) }}:
        name: VSEngSS-MicroBuild2022-1ES
        demands: Cmd
    strategy:
      matrix:
        Release:
          _BuildConfig: Release
        ${{ if eq(variables._RunAsPublic, True) }}:
          Debug:
            _BuildConfig: Debug
    steps:
    - task: NuGetToolInstaller@0
      displayName: 'Pull in NuGet $(NuGet.Version)'
      inputs:
        versionSpec: $(NuGet.Version)

    - task: PowerShell@2
      displayName: 'Install Windows SDK'
      inputs:
        targetType: filePath
        filePath: './scripts/Install-WindowsSDK.ps1'
        failOnStderr: true
        showWarnings: true

    - ${{ if eq(variables._RunAsPublic, True) }}:
      - powershell: |
          reg DELETE "HKLM\Software\Microsoft\StrongName\Verification" /f
          reg ADD "HKLM\Software\Microsoft\StrongName\Verification\*,*" /f
          reg DELETE "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification" /f
          reg ADD "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification\*,*" /f
        displayName: 'Disable strongname validation'

    - ${{ if eq(variables._RunAsInternal, True) }}:
      - task: PowerShell@2
        displayName: Set version variables
        inputs:
          filePath: ./scripts/vsts-prebuild.ps1
          arguments: -IsRtmBuild ${{ parameters.isRTM }}

      - powershell: |
          $script = "./scripts/write-release-notes.ps1"
          $p = @{
              Path = "$pwd"
              PackageVersion = "$(TestAdapterNugetVersion)"
          }

          if (Test-Path $script) {
              & "$script" @p
          }
          else {
              Write-Host "Path '$script' does not exist, skipping."
          }
        displayName: 'Generate release notes'

      - task: MicroBuildSigningPlugin@4
        displayName: Install MicroBuild plugin for Signing
        inputs:
          signType: $(_SignType)
          zipSources: true
          feedSource: 'https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json'

      # Install Swix Plugin
      # Loc build

    - task: BatchScript@1
      displayName: 'Restore, Build and Package'
      inputs:
        filename: build.cmd
        arguments: '-configuration $(_BuildConfig) -CI'
        modifyEnvironment: false

    - ${{ if eq(variables._RunAsInternal, True) }}:
      - powershell: 'New-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Fusion -Name "EnableLog" -Value 1 -PropertyType "DWord" -Force'
        errorActionPreference: continue
        displayName: 'Enable FusionLog'

    - task: BatchScript@1
      displayName: 'Run All Tests'
      inputs:
        filename: test.cmd
        arguments: '-configuration $(_BuildConfig) -all -parallel'
        modifyEnvironment: false

    - ${{ if eq(variables._RunAsInternal, True) }}:
      - powershell: 'New-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Fusion -Name "EnableLog" -Value 0 -PropertyType "DWord" -Force'
        errorActionPreference: continue
        displayName: 'Disable FusionLog'
      #Sign packages
      #Verify signing

    - ${{ if eq(variables._RunAsPublic, True) }}:
      - task: ComponentGovernanceComponentDetection@0
        displayName: 'Component Governance'
        inputs:
          scanType: 'Register'
          verbosity: 'Verbose'
          alertWarningLevel: 'High'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results **\*.trx'
      inputs:
        testResultsFormat: VSTest
        testResultsFiles: '**\*.trx'
      condition: succeededOrFailed()

    #- ${{ if eq(variables._RunAsInternal, True) }}:
    #Publish loc artifacts
    #Publish artifacts success/fail
    #Publish nuget
    #Convert to full pdb
    #symbols
    #micro build cleanup

  - job: Markdownlint
    pool:
        vmImage: ubuntu-22.04
    steps:
      - script: sudo npm install -g markdownlint-cli@0.32.2
        displayName: Install markdownlint-cli
      - script: markdownlint '**/*.md'
        displayName: Run markdownlint