trigger:
  branches:
    include:
    - main
    - rel/*

# Branch(es) that trigger(s) build(s) on PR
pr:
  branches:
    include:
    - main
    - rel/*
    - dev/v4
  paths:
    exclude:
      - .github/*
      - .devcontainer/*
      - docs/*
      - .markdownlint.json
      - .markdownlintignore
      - CODE_OF_CONDUCT.md
      - CONTRIBUTING.md
      - README.md
      - SECURITY.md
      - src/**/*.xlf

parameters:
# This option should be used with caution. This is useful for unblocking circular deps issue with testanywhere
- name: SkipTests
  displayName: "Skip tests"
  type: boolean
  default: False

variables:
  # Cannot use key:value syntax in root defined variables
  - name: _TeamName
    value: MSTest
  - name: _RunAsInternal
    value: False
  - name: _RunAsPublic
    value: True

stages:

# Stage 1: Windows builds all products, runs unit tests, and publishes packages
- stage: BuildAndPack
  displayName: Build, Unit Tests, and Pack (Windows)
  jobs:
  - template: /eng/common/templates/jobs/jobs.yml
    parameters:
      enableMicrobuild: true
      enablePublishBuildArtifacts: true
      enablePublishTestResults: true
      testResultsFormat: 'vstest'
      enablePublishBuildAssets: true
      enablePublishUsingPipelines: true
      enableTelemetry: true
      jobs:
      - job: Windows_BuildAndPack
        displayName: Windows Build, Unit Tests, and Pack
        timeoutInMinutes: 90
        condition: ne('${{ parameters.SkipTests }}', 'True')
        pool:
          name: NetCore-Public
          demands: ImageOverride -equals windows.vs2022preview.amd64.open
        strategy:
          matrix:
            Debug:
              _BuildConfig: Debug
            Release:
              _BuildConfig: Release
        steps:
        - template: /eng/windows-setup-steps.yml

        # Build all products and run unit tests
        - script: eng\common\CIBuild.cmd
            -configuration $(_BuildConfig)
            -prepareMachine
            /p:Publish=false
            /p:ProductsToBuild=all
            /p:Test=false
            /p:FastAcceptanceTest=true
          name: BuildAll
          displayName: Build All Products

        # Run unit tests for both MSTest and Testing Platform
        - script: dotnet test test/UnitTests -c $(_BuildConfig) --no-build -bl:$(BUILD.SOURCESDIRECTORY)\artifacts\TestResults\$(_BuildConfig)\UnitTests.binlog --no-progress
          name: UnitTests
          displayName: Run Unit Tests
          env:
            DOTNET_ROOT: $(Build.SourcesDirectory)/.dotnet
            NUGET_PACKAGES: $(Build.SourcesDirectory)/.packages
            DOTNET_CLI_CONTEXT_VERBOSE: 1

        # Pack only in Release configuration
        - script: eng\common\CIBuild.cmd
            -configuration Release
            -prepareMachine
            /p:Publish=false
            /p:ProductsToBuild=all
            /p:Test=false
            /p:Pack=true
          name: Pack
          displayName: Pack NuGet Packages
          condition: eq(variables._BuildConfig, 'Release')

        - task: PublishBuildArtifacts@1
          displayName: 'Publish NuGet packages for integration testing'
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/artifacts/packages/Release'
            ArtifactName: 'NuGetPackages'
          condition: and(always(), eq(variables._BuildConfig, 'Release'))

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Unit Test Results'
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/artifacts/TestResults/$(_BuildConfig)'
            ArtifactName: UnitTestResults_Windows_$(_BuildConfig)_Attempt$(System.JobAttempt)
          condition: always()

# Stage 2: Linux Unit Tests (parallel, no dependency)
- template: /eng/unit-test-stage-template.yml
  parameters:
    stageName: UnitTestsLinux
    displayName: Unit Tests Linux (MSTest)
    os: Linux
    skipTests: ${{ parameters.SkipTests }}
    productFilter: mstest-unit-tests
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals build.ubuntu.2004.amd64.open

- template: /eng/unit-test-stage-template.yml
  parameters:
    stageName: UnitTestsLinuxMTP
    displayName: Unit Tests Linux (Testing Platform)
    os: Linux
    skipTests: ${{ parameters.SkipTests }}
    productFilter: testing-platform-unit-tests
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals build.ubuntu.2004.amd64.open

# Stage 3: macOS Unit Tests (parallel, no dependency)  
- template: /eng/unit-test-stage-template.yml
  parameters:
    stageName: UnitTestsMacOS
    displayName: Unit Tests macOS (MSTest)
    os: macOS
    skipTests: ${{ parameters.SkipTests }}
    productFilter: mstest-unit-tests
    pool:
      name: Azure Pipelines
      vmImage: macos-latest
      os: macOS

- template: /eng/unit-test-stage-template.yml
  parameters:
    stageName: UnitTestsMacOSMTP
    displayName: Unit Tests macOS (Testing Platform)
    os: macOS
    skipTests: ${{ parameters.SkipTests }}
    productFilter: testing-platform-unit-tests
    pool:
      name: Azure Pipelines
      vmImage: macos-latest
      os: macOS

# Stage 4: Integration Tests on all platforms (depends on Windows build)
- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsWindows
    displayName: Integration Tests Windows (MSTest)
    dependsOn: BuildAndPack
    os: Windows
    skipTests: ${{ parameters.SkipTests }}
    productFilter: mstest-integration-tests
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals windows.vs2022preview.amd64.open

- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsWindowsMTP
    displayName: Integration Tests Windows (Testing Platform)
    dependsOn: BuildAndPack
    os: Windows
    skipTests: ${{ parameters.SkipTests }}
    productFilter: testing-platform-integration-tests
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals windows.vs2022preview.amd64.open

- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsLinux
    displayName: Integration Tests Linux (MSTest)
    dependsOn: BuildAndPack
    os: Linux
    skipTests: ${{ parameters.SkipTests }}
    productFilter: mstest-integration-tests
    solutionFile: NonWindowsTests.slnf
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals build.ubuntu.2004.amd64.open

- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsLinuxMTP
    displayName: Integration Tests Linux (Testing Platform)
    dependsOn: BuildAndPack
    os: Linux
    skipTests: ${{ parameters.SkipTests }}
    productFilter: testing-platform-integration-tests
    solutionFile: NonWindowsTests.slnf
    pool:
      name: NetCore-Public
      demands: ImageOverride -equals build.ubuntu.2004.amd64.open

- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsMacOS
    displayName: Integration Tests macOS (MSTest)
    dependsOn: BuildAndPack
    os: macOS
    skipTests: ${{ parameters.SkipTests }}
    productFilter: mstest-integration-tests
    solutionFile: NonWindowsTests.slnf
    pool:
      name: Azure Pipelines
      vmImage: macos-latest
      os: macOS

- template: /eng/integration-test-stage-template.yml
  parameters:
    stageName: IntegrationTestsMacOSMTP
    displayName: Integration Tests macOS (Testing Platform)
    dependsOn: BuildAndPack
    os: macOS
    skipTests: ${{ parameters.SkipTests }}
    productFilter: testing-platform-integration-tests
    solutionFile: NonWindowsTests.slnf
    pool:
      name: Azure Pipelines
      vmImage: macos-latest
      os: macOS
