# Branches that trigger a build on commit
trigger:
- main
- rel/*

# Branch(es) that trigger(s) build(s) on PR
pr:
- main
- rel/*

jobs:
- job: Windows
  timeoutInMinutes: 120
  pool:
    vmImage: 'windows-latest'
  variables:
    buildConfiguration: 'Release'

  steps:

  - task: NuGetToolInstaller@0
    displayName: 'Pull in NuGet 5.8.1'
    inputs:
      versionSpec: 5.8.1

  - task: PowerShell@2
    displayName: 'Install Windows SDK'
    inputs:
      targetType: filePath
      filePath: './scripts/Install-WindowsSDK.ps1'
      failOnStderr: true
      showWarnings: true

  - powershell: |
      reg DELETE "HKLM\Software\Microsoft\StrongName\Verification" /f
      reg ADD "HKLM\Software\Microsoft\StrongName\Verification\*,*" /f
      reg DELETE "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification" /f
      reg ADD "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification\*,*" /f
    displayName: 'Disable strongname validation'

  - task: BatchScript@1
    displayName: 'Restore, Build and Package'
    inputs:
      filename: build.cmd
      arguments: '-configuration $(BuildConfiguration) -CI'
      modifyEnvironment: false

  - task: BatchScript@1
    displayName: 'Run All Tests'
    inputs:
      filename: test.cmd
      arguments: '-configuration $(BuildConfiguration) -all -parallel'
      modifyEnvironment: false

  - task: ComponentGovernanceComponentDetection@0
    displayName: 'Component Governance'
    inputs:
      scanType: 'Register'
      verbosity: 'Verbose'
      alertWarningLevel: 'High'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results **\*.trx'
    inputs:
      testResultsFormat: VSTest
      testResultsFiles: '**\*.trx'
    condition: succeededOrFailed()

- job: Markdownlint
  pool:
      vmImage: ubuntu-22.04
  steps:
    - script: sudo npm install -g markdownlint-cli@0.32.2
      displayName: Install markdownlint-cli
    - script: markdownlint '**/*.md'
      displayName: Run markdownlint