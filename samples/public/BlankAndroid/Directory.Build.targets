<Project>
  <PropertyGroup>
    <_IsDeviceTestProject Condition="$(TargetFramework.Contains('android')) OR $(TargetFramework.Contains('ios'))">true</_IsDeviceTestProject>
    <UseMSBuildTestInfrastructure Condition="'$(_IsDeviceTestProject)' == 'true'">true</UseMSBuildTestInfrastructure>
    <DeviceId Condition="'$(DeviceId)' == ''">$(DEVICE_ID)</DeviceId>
    <DotnetDevicePath Condition="'$(DotnetDevicePath)' == ''">$(DOTNET_DEVICE_PATH)</DotnetDevicePath>
    <DotnetDevicePath Condition="'$(DotnetDevicePath)' == ''">dotnet</DotnetDevicePath>
  </PropertyGroup>

  <Target Name="_MTPBeforeVSTest" BeforeTargets="VSTest" Condition="'$(_IsDeviceTestProject)' == 'true'">
    <Message Text="Device project detected, skipping MTP VSTest error check" Importance="low" />
  </Target>

  <Target Name="VSTest" Condition="'$(_IsDeviceTestProject)' == 'true'">
    <Message Text="" Importance="high" />
    <Message Text="╔══════════════════════════════════════════════════════════════╗" Importance="high" />
    <Message Text="║               DEVICE TESTING (Microsoft.Testing.Platform)    ║" Importance="high" />
    <Message Text="╠══════════════════════════════════════════════════════════════╣" Importance="high" />
    <Message Text="║  Project:    $(MSBuildProjectName)" Importance="high" />
    <Message Text="║  Framework:  $(TargetFramework)" Importance="high" />
    <Message Text="║  Device:     $(DeviceId)" Importance="high" Condition="'$(DeviceId)' != ''" />
    <Message Text="╚══════════════════════════════════════════════════════════════╝" Importance="high" />
    <Message Text="" Importance="high" />
    
    <CallTarget Targets="Build" Condition="'$(VSTestNoBuild)' != 'true'" />
    <CallTarget Targets="_InvokeDeviceTestingPlatform" />
  </Target>

  <Target Name="_InvokeDeviceTestingPlatform">
    <PropertyGroup>
      <_DotnetRunArgs>run --project "$(MSBuildProjectFullPath)" -f $(TargetFramework)</_DotnetRunArgs>
      <_DotnetRunArgs Condition="'$(DeviceId)' != ''">$(_DotnetRunArgs) --device $(DeviceId)</_DotnetRunArgs>
      <_TestOutputFile>$(IntermediateOutputPath)device_test_output.txt</_TestOutputFile>
    </PropertyGroup>

    <Message Text="Deploying and running tests on device..." Importance="high" />
    
    <!-- Run dotnet run and capture output to a file -->
    <Exec Command="&quot;$(DotnetDevicePath)&quot; $(_DotnetRunArgs) > &quot;$(_TestOutputFile)&quot; 2>&amp;1"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true">
      <Output TaskParameter="ExitCode" PropertyName="_DeviceTestExitCode" />
    </Exec>

    <!-- Filter and display test output directly to console (stderr goes through even at minimal verbosity) -->
    <Exec Command="grep -E 'MTP\.|BlankAndroid:|Tests completed|exit code' &quot;$(_TestOutputFile)&quot; | sed 's/^.*I //' 1>&amp;2 || true"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true" />

    <Message Text="" Importance="high" />
    <Message Text="══════════════════════════════════════════════════════════════" Importance="high" />
    <Message Text="Device test exit code: $(_DeviceTestExitCode)" Importance="high" Condition="'$(_DeviceTestExitCode)' == '0'" />
    <Error Text="Device tests failed with exit code: $(_DeviceTestExitCode)" Condition="'$(_DeviceTestExitCode)' != '0'" />
  </Target>
</Project>
