<Project>
  <PropertyGroup>
    <_IsDeviceTestProject Condition="$(TargetFramework.Contains('android')) OR $(TargetFramework.Contains('ios'))">true</_IsDeviceTestProject>
    <UseMSBuildTestInfrastructure Condition="'$(_IsDeviceTestProject)' == 'true'">true</UseMSBuildTestInfrastructure>
    <DeviceId Condition="'$(DeviceId)' == ''">$(DEVICE_ID)</DeviceId>
    <DotnetDevicePath Condition="'$(DotnetDevicePath)' == ''">$(DOTNET_DEVICE_PATH)</DotnetDevicePath>
    <DotnetDevicePath Condition="'$(DotnetDevicePath)' == ''">dotnet</DotnetDevicePath>
  </PropertyGroup>

  <Target Name="_MTPBeforeVSTest" BeforeTargets="VSTest" Condition="'$(_IsDeviceTestProject)' == 'true'">
    <Message Text="Device project detected, skipping MTP VSTest error check" Importance="low" />
  </Target>

  <Target Name="VSTest" Condition="'$(_IsDeviceTestProject)' == 'true'">
    <Message Text="" Importance="high" />
    <Message Text="╔══════════════════════════════════════════════════════════════╗" Importance="high" />
    <Message Text="║               DEVICE TESTING (Microsoft.Testing.Platform)    ║" Importance="high" />
    <Message Text="╠══════════════════════════════════════════════════════════════╣" Importance="high" />
    <Message Text="║  Project:    $(MSBuildProjectName)" Importance="high" />
    <Message Text="║  Framework:  $(TargetFramework)" Importance="high" />
    <Message Text="║  Device:     $(DeviceId)" Importance="high" Condition="'$(DeviceId)' != ''" />
    <Message Text="╚══════════════════════════════════════════════════════════════╝" Importance="high" />
    <Message Text="" Importance="high" />
    
    <CallTarget Targets="Build" Condition="'$(VSTestNoBuild)' != 'true'" />
    <CallTarget Targets="_RunTestsOnDevice" />
  </Target>

  <!-- Run tests on device using dotnet run with logcat monitoring -->
  <Target Name="_RunTestsOnDevice">
    <PropertyGroup>
      <_AdbDevice Condition="'$(DeviceId)' != ''">-s $(DeviceId)</_AdbDevice>
      <_DotnetRunArgs>run --project "$(MSBuildProjectFullPath)" -f $(TargetFramework)</_DotnetRunArgs>
      <_DotnetRunArgs Condition="'$(DeviceId)' != ''">$(_DotnetRunArgs) --device $(DeviceId)</_DotnetRunArgs>
      <_TestOutputFile>$(IntermediateOutputPath)device_test_output.txt</_TestOutputFile>
      <_LocalTestResultsPath>$(OutputPath)TestResults</_LocalTestResultsPath>
    </PropertyGroup>

    <!-- Clear logcat before running tests -->
    <Exec Command="adb $(_AdbDevice) logcat -c"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true" />

    <Message Text="" Importance="high" />
    <Message Text="Deploying and running tests on device..." Importance="high" />
    <Message Text="Command: dotnet $(_DotnetRunArgs)" Importance="high" />
    <Message Text="" Importance="high" />
    
    <!-- 
      Run dotnet run which deploys and starts the app.
      The app will call Java.Lang.JavaSystem.Exit() when tests complete.
      We capture the output to get the exit code.
    -->
    <Exec Command="&quot;$(DotnetDevicePath)&quot; $(_DotnetRunArgs) 2>&amp;1 | tee &quot;$(_TestOutputFile)&quot;"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true">
      <Output TaskParameter="ExitCode" PropertyName="_DeviceTestExitCode" />
    </Exec>

    <!-- Get test results from logcat -->
    <Message Text="" Importance="high" />
    <Message Text="Test output from device:" Importance="high" />
    <Exec Command="adb $(_AdbDevice) logcat -d -s BlankAndroid:I DeviceTests:I MTP:I TestInstrumentation:I | grep -E 'BlankAndroid|MTP|DeviceTests|TestInstrumentation' | tail -100"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true" />

    <!-- Collect test results from device -->
    <CallTarget Targets="_CollectDeviceTestResults" />

    <Message Text="" Importance="high" />
    <Message Text="══════════════════════════════════════════════════════════════" Importance="high" />
    <Message Text="✓ Tests completed with exit code: $(_DeviceTestExitCode)" Importance="high" Condition="'$(_DeviceTestExitCode)' == '0'" />
    <Error Text="✗ Tests failed with exit code: $(_DeviceTestExitCode)" Condition="'$(_DeviceTestExitCode)' != '0'" />
  </Target>

  <Target Name="_CollectDeviceTestResults">
    <PropertyGroup>
      <_AdbDevice Condition="'$(DeviceId)' != ''">-s $(DeviceId)</_AdbDevice>
      <_DeviceTestResultsPath>files/TestResults</_DeviceTestResultsPath>
      <_LocalTestResultsPath>$(OutputPath)TestResults</_LocalTestResultsPath>
    </PropertyGroup>

    <!-- Create local TestResults directory -->
    <MakeDir Directories="$(_LocalTestResultsPath)" />

    <Message Text="" Importance="high" />
    <Message Text="Collecting test results from device..." Importance="high" />

    <!-- Get the most recent TRX file name -->
    <Exec Command="adb $(_AdbDevice) shell &quot;run-as $(ApplicationId) ls -t $(_DeviceTestResultsPath)/ 2>/dev/null | head -1&quot; | tr -d '\r'"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true"
          ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="_LatestTrxFileName" />
    </Exec>

    <!-- Pull the latest TRX file using run-as + cat -->
    <Exec Command="adb $(_AdbDevice) shell &quot;run-as $(ApplicationId) cat $(_DeviceTestResultsPath)/$(_LatestTrxFileName)&quot; > &quot;$(_LocalTestResultsPath)/$(MSBuildProjectName).trx&quot;"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true"
          Condition="'$(_LatestTrxFileName)' != '' AND $(_LatestTrxFileName.EndsWith('.trx'))" />

    <!-- Show result -->
    <Message Text="Test results: $(_LocalTestResultsPath)/$(MSBuildProjectName).trx" Importance="high" Condition="'$(_LatestTrxFileName)' != '' AND $(_LatestTrxFileName.EndsWith('.trx'))" />
  </Target>
</Project>
